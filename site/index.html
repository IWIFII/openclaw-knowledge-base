<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>创新π协会成员名录</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700;900&display=swap" rel="stylesheet" />
  <style>
    :root { --bg:#f7f5ef; --panel:#fffef9; --ink:#1f2328; --muted:#6a7178; --line:#d9d4c7; --brand:#0d5c63; --ok:#2b9348; --card:#fffdf6; --danger:#c44536; }
    *{box-sizing:border-box}
    body{margin:0;color:var(--ink);font-family:"Noto Sans SC","PingFang SC",sans-serif;background:radial-gradient(circle at 10% 20%,#fff3d6 0%,transparent 32%),radial-gradient(circle at 85% 30%,#dff3ff 0%,transparent 35%),var(--bg);min-height:100vh}
    .wrap{width:min(1080px,94vw);margin:24px auto;padding:24px;border:1px solid var(--line);border-radius:18px;background:linear-gradient(180deg,rgba(255,255,255,.95),rgba(255,255,255,.85));box-shadow:0 16px 40px rgba(40,45,50,.08);animation:fadeUp .5s ease both}
    @keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
    h1{margin:0;font-size:clamp(26px,4vw,38px);font-weight:900}
    .sub{margin-top:8px;color:var(--muted);font-size:14px}
    .topbar{margin-top:14px;display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    .auth{font-size:13px;color:var(--muted)}
    .auth-btn{border:1px solid var(--brand);color:var(--brand);background:#f2fbfc;border-radius:10px;padding:7px 11px;font-size:13px;cursor:pointer}
    .toolbar{margin-top:16px;display:grid;grid-template-columns:1fr auto;gap:12px}
    input{width:100%;border:1px solid var(--line);border-radius:12px;padding:12px 14px;font-size:15px;outline:none;background:var(--panel)}
    input:focus{border-color:var(--brand);box-shadow:0 0 0 3px rgba(13,92,99,.14)}
    .count{border:1px solid var(--line);border-radius:12px;padding:11px 14px;font-size:14px;color:var(--brand);background:rgba(13,92,99,.08);white-space:nowrap}
    .grid{margin-top:16px;display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:14px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;box-shadow:0 8px 20px rgba(20,25,30,.05);display:flex;flex-direction:column;gap:8px;opacity:0;transform:translateY(8px) scale(.99);animation:cardIn .34s ease forwards}
    @keyframes cardIn{to{opacity:1;transform:translateY(0) scale(1)}}
    .seq{display:inline-block;font-size:12px;color:var(--muted);padding:2px 8px;border:1px dashed #c9c1ad;border-radius:999px;width:fit-content}
    .name{margin:0;font-size:20px;font-weight:800}
    .line{margin:0;font-size:14px;color:var(--muted)}
    .label{color:var(--brand);font-weight:700;margin-right:6px}
    .badge{display:inline-flex;align-items:center;border:1px solid #b7d7c0;color:var(--ok);padding:2px 8px;border-radius:999px;font-size:12px;background:#eef9f1;width:fit-content}
    .btn{margin-top:auto;border:1px solid var(--brand);color:var(--brand);background:#f2fbfc;border-radius:10px;padding:8px 10px;font-size:13px;cursor:pointer}
    .empty{margin-top:18px;text-align:center;color:var(--muted);padding:30px 10px;border:1px dashed var(--line);border-radius:12px;background:#fffdf9}
    .foot{margin-top:14px;color:var(--muted);font-size:13px}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.42);display:none;align-items:center;justify-content:center;padding:16px;z-index:999}
    .modal.show{display:flex}
    .panel{width:min(760px,96vw);max-height:86vh;overflow:auto;background:#fff;border-radius:14px;border:1px solid var(--line);padding:16px;animation:fadeUp .24s ease both}
    .panel-head{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:10px}
    .panel h3{margin:0;font-size:24px}
    .close{border:1px solid var(--line);background:#f6f6f6;border-radius:8px;padding:6px 9px;cursor:pointer}
    .detail-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px 14px;margin-top:10px}
    .detail-item{border-bottom:1px dashed #e5e0d4;padding-bottom:6px;font-size:14px}
    .detail-label{color:var(--brand);font-weight:700;margin-right:6px}
    .detail-block{margin-top:12px;padding:10px;border:1px solid #ebe5d9;border-radius:10px;background:#fffcf4;font-size:14px;line-height:1.55}
    .login-box{margin-top:14px;padding:12px;border:1px solid #f0d2d2;border-radius:12px;background:#fff6f6;font-size:13px;color:#733;display:none}
    .login-box.show{display:block}
    .err{color:var(--danger);font-size:12px;margin-top:6px;min-height:16px}
    @media (max-width:720px){.wrap{margin:12px auto;padding:16px}.toolbar{grid-template-columns:1fr}.grid{grid-template-columns:1fr}.detail-grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <main class="wrap">
    <h1>创新π协会成员名录</h1>
    <p class="sub">未登录可看基础信息；登录后可查看完整个人详情卡片。</p>
    <section class="topbar">
      <div class="auth" id="authText">当前状态：未登录（仅可查看部分信息）</div>
      <button class="auth-btn" id="authBtn" type="button">登录查看完整信息</button>
    </section>
    <section class="toolbar">
      <label><input id="search" type="search" placeholder="搜索姓名（例如：喻文辉）" /></label>
      <div class="count" id="count">共 0 人</div>
    </section>
    <section class="grid" id="cards" aria-live="polite"></section>
    <p class="foot">数据来自报名/备案文档自动提取，个别字段可能待人工校对。</p>
  </main>

  <section class="modal" id="modal">
    <article class="panel">
      <div class="panel-head"><h3 id="modalName">成员详情</h3><button class="close" id="closeBtn" type="button">关闭</button></div>
      <div id="loginPrompt" class="login-box">你当前未登录，只能查看基础信息。请先登录再查看完整详情。</div>
      <div class="detail-grid" id="detailGrid"></div>
      <div class="detail-block" id="detailResume"></div>
      <div class="detail-block" id="detailIdea"></div>
    </article>
  </section>

  <section class="modal" id="loginModal">
    <article class="panel" style="width:min(440px,96vw)">
      <div class="panel-head"><h3>登录</h3><button class="close" id="closeLogin" type="button">关闭</button></div>
      <label class="line"><span class="label">账号</span><input id="username" type="text" placeholder="请输入账号" /></label>
      <label class="line" style="margin-top:10px;"><span class="label">密码</span><input id="password" type="password" placeholder="请输入密码" /></label>
      <div class="err" id="loginErr"></div>
      <button class="auth-btn" id="doLogin" type="button">登录</button>
    </article>
  </section>

  <script>
    let token = localStorage.getItem("pi_member_token") || "";
    let isLoggedIn = !!token;
    let members = [];
    let fullMembers = [];

    const cards = document.getElementById("cards");
    const count = document.getElementById("count");
    const search = document.getElementById("search");
    const modal = document.getElementById("modal");
    const modalName = document.getElementById("modalName");
    const detailGrid = document.getElementById("detailGrid");
    const detailResume = document.getElementById("detailResume");
    const detailIdea = document.getElementById("detailIdea");
    const closeBtn = document.getElementById("closeBtn");
    const loginPrompt = document.getElementById("loginPrompt");
    const authText = document.getElementById("authText");
    const authBtn = document.getElementById("authBtn");
    const loginModal = document.getElementById("loginModal");
    const closeLogin = document.getElementById("closeLogin");
    const doLogin = document.getElementById("doLogin");
    const username = document.getElementById("username");
    const password = document.getElementById("password");
    const loginErr = document.getElementById("loginErr");

    function updateAuthUI() {
      authText.textContent = isLoggedIn
        ? "当前状态：已登录（可查看完整信息）"
        : "当前状态：未登录（仅可查看部分信息）";
      authBtn.textContent = isLoggedIn ? "退出登录" : "登录查看完整信息";
    }

    function line(label, value) {
      return `<div class="detail-item"><span class="detail-label">${label}</span>${value || "待补充"}</div>`;
    }

    function getMemberByName(name) {
      if (isLoggedIn) return fullMembers.find((m) => m.name === name) || { name };
      return members.find((m) => m.name === name) || { name };
    }

    function openDetail(name) {
      const m = getMemberByName(name);
      modalName.textContent = name + " · 详细信息";
      if (!isLoggedIn) {
        loginPrompt.classList.add("show");
        detailGrid.innerHTML = [
          line("学号", "***"),
          line("性别", m.gender || "待补充"),
          line("班级", m.className || "待补充"),
          line("专业", m.major || "待补充"),
          line("联系方式", "登录后可见"),
          line("QQ", "登录后可见"),
          line("性格", "登录后可见"),
          line("爱好特长", "登录后可见")
        ].join("");
        detailResume.innerHTML = "<span class='detail-label'>个人简历</span>登录后可查看完整简历";
        detailIdea.innerHTML = "<span class='detail-label'>想法/项目构想</span>登录后可查看完整内容";
      } else {
        loginPrompt.classList.remove("show");
        detailGrid.innerHTML = [
          line("学号", m.studentId), line("性别", m.gender), line("班级", m.className), line("专业", m.major),
          line("联系方式", m.phone), line("QQ", m.qq), line("性格", m.personality), line("爱好特长", m.hobby)
        ].join("");
        detailResume.innerHTML = `<span class='detail-label'>个人简历</span>${m.resume || "待补充"}`;
        detailIdea.innerHTML = `<span class='detail-label'>想法/项目构想</span>${m.idea || "待补充"}`;
      }
      modal.classList.add("show");
    }

    function render(list) {
      cards.innerHTML = "";
      if (!list.length) {
        cards.innerHTML = '<div class="empty">没有匹配到成员，请换个关键词试试。</div>';
      } else {
        list.forEach((m, i) => {
          const card = document.createElement("article");
          card.className = "card";
          card.style.animationDelay = `${i * 35}ms`;
          card.innerHTML = `
            <span class="seq">成员 #${i + 1}</span>
            <h2 class="name">${m.name}</h2>
            <p class="line"><span class="label">班级</span>${m.className || "待补充"}</p>
            <p class="line"><span class="label">专业</span>${m.major || "待补充"}</p>
            <span class="badge">已收录</span>
            <button class="btn" type="button">查看详情</button>
          `;
          card.querySelector(".btn").addEventListener("click", () => openDetail(m.name));
          cards.appendChild(card);
        });
      }
      count.textContent = `共 ${list.length} 人`;
    }

    async function fetchPartial() {
      const res = await fetch("/api/members");
      const data = await res.json();
      members = data.members || [];
    }

    async function fetchFull() {
      const res = await fetch("/api/members/full", {
        headers: { Authorization: `Bearer ${token}` }
      });
      if (!res.ok) throw new Error("unauthorized");
      const data = await res.json();
      fullMembers = data.members || [];
    }

    async function refreshData() {
      await fetchPartial();
      if (isLoggedIn) {
        try {
          await fetchFull();
        } catch {
          isLoggedIn = false;
          token = "";
          localStorage.removeItem("pi_member_token");
          fullMembers = [];
        }
      }
      updateAuthUI();
      applySearch();
    }

    function applySearch() {
      const q = search.value.trim();
      const source = isLoggedIn && fullMembers.length ? fullMembers : members;
      if (!q) return render(source);
      render(source.filter((m) => m.name.includes(q)));
    }

    async function doLoginCheck() {
      const payload = { username: username.value.trim(), password: password.value };
      const res = await fetch("/api/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      if (!res.ok) {
        loginErr.textContent = "账号或密码错误，请重试。";
        return;
      }
      const data = await res.json();
      token = data.token;
      localStorage.setItem("pi_member_token", token);
      isLoggedIn = true;
      loginErr.textContent = "";
      loginModal.classList.remove("show");
      await refreshData();
    }

    authBtn.addEventListener("click", async () => {
      if (isLoggedIn) {
        isLoggedIn = false;
        token = "";
        localStorage.removeItem("pi_member_token");
        fullMembers = [];
        updateAuthUI();
        applySearch();
        return;
      }
      username.value = "";
      password.value = "";
      loginErr.textContent = "";
      loginModal.classList.add("show");
      username.focus();
    });

    closeLogin.addEventListener("click", () => loginModal.classList.remove("show"));
    doLogin.addEventListener("click", doLoginCheck);
    password.addEventListener("keydown", (e) => { if (e.key === "Enter") doLoginCheck(); });

    closeBtn.addEventListener("click", () => modal.classList.remove("show"));
    modal.addEventListener("click", (e) => { if (e.target === modal) modal.classList.remove("show"); });
    loginModal.addEventListener("click", (e) => { if (e.target === loginModal) loginModal.classList.remove("show"); });
    search.addEventListener("input", applySearch);

    refreshData();
  </script>
</body>
</html>
