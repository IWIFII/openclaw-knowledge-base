<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>创新π协会成员名录</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700;900&display=swap" rel="stylesheet" />
  <style>
    :root { --bg:#f5f7fb; --panel:#fff; --line:#dfe4ee; --ink:#1f2a37; --muted:#667085; --brand:#0f766e; --brand-soft:#e8f7f5; --warn:#c0392b; }
    * { box-sizing: border-box; }
    body { margin:0; font-family:"Noto Sans SC",sans-serif; color:var(--ink); background:linear-gradient(180deg,#f8f9fc,var(--bg)); }
    .app { width:min(1220px,96vw); margin:14px auto 26px; border:1px solid var(--line); border-radius:14px; background:var(--panel); box-shadow:0 12px 32px rgba(24,39,75,.08); overflow:hidden; }
    .head { display:flex; justify-content:space-between; align-items:center; gap:12px; padding:14px 16px; border-bottom:1px solid var(--line); background:#fbfcff; flex-wrap:wrap; }
    .title { margin:0; font-size:24px; font-weight:900; }
    .desc { margin:4px 0 0; color:var(--muted); font-size:13px; }
    .head-right { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .status { font-size:12px; color:var(--muted); border:1px solid var(--line); border-radius:999px; padding:5px 10px; }
    .btn { border:1px solid var(--brand); background:var(--brand-soft); color:var(--brand); border-radius:8px; padding:7px 12px; font-weight:700; cursor:pointer; }
    .layout { display:grid; grid-template-columns:340px 1fr; min-height:72vh; }
    .sidebar { border-right:1px solid var(--line); padding:12px; background:#fcfdff; }
    .search { width:100%; border:1px solid var(--line); border-radius:10px; padding:10px 11px; font-size:14px; outline:none; margin-bottom:10px; }
    .search:focus { border-color:var(--brand); box-shadow:0 0 0 3px rgba(15,118,110,.14); }
    .count { color:var(--muted); font-size:12px; margin-bottom:10px; }
    .member-list { display:grid; gap:8px; max-height:calc(72vh - 90px); overflow:auto; padding-right:4px; }
    .member-item { border:1px solid var(--line); border-radius:10px; padding:10px; cursor:pointer; background:#fff; }
    .member-item:hover { border-color:#a8b7d4; background:#f9fbff; }
    .member-item.active { border-color:var(--brand); background:#eefaf8; }
    .member-name { font-weight:800; margin:0; font-size:15px; }
    .member-meta { margin-top:4px; font-size:12px; color:var(--muted); }
    .content { padding:16px; }
    .detail-title { display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap; margin-bottom:10px; }
    .detail-name { margin:0; font-size:26px; font-weight:900; }
    .tag { border:1px solid #b9d8d3; color:#0b7667; background:#edf9f7; border-radius:999px; padding:3px 9px; font-size:12px; font-weight:700; }
    .grid { display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:10px; margin-top:10px; }
    .field { border:1px solid var(--line); border-radius:10px; padding:10px; background:#fff; }
    .field-k { color:var(--muted); font-size:12px; margin-bottom:5px; }
    .field-v { font-size:14px; line-height:1.45; word-break:break-word; }
    .block { margin-top:10px; border:1px solid var(--line); border-radius:10px; padding:10px; background:#fff; }
    .block h3 { margin:0 0 6px; font-size:14px; color:#374151; }
    .block p { margin:0; color:#334155; font-size:14px; line-height:1.65; white-space:pre-wrap; }
    .locked { margin-top:12px; border:1px solid #f0c9c6; background:#fff6f5; color:#8a2f26; border-radius:10px; padding:9px 10px; font-size:13px; }
    .empty-detail { color:var(--muted); font-size:14px; padding:20px; border:1px dashed var(--line); border-radius:10px; background:#fff; }
    .modal { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(17,24,39,.45); z-index:99; padding:14px; }
    .modal.show { display:flex; }
    .login-panel { width:min(420px,96vw); background:#fff; border:1px solid var(--line); border-radius:12px; padding:14px; }
    .login-title { margin:0 0 10px; font-size:20px; font-weight:800; }
    .in { width:100%; border:1px solid var(--line); border-radius:9px; padding:10px; margin-bottom:9px; outline:none; }
    .in:focus { border-color:var(--brand); }
    .err { color:var(--warn); font-size:12px; min-height:16px; }
    .login-actions { display:flex; gap:8px; }
    .btn-ghost { border:1px solid var(--line); background:#f8fafc; color:#475569; border-radius:8px; padding:7px 12px; cursor:pointer; }

    .chat-fab { position:fixed; right:18px; bottom:18px; z-index:60; border:1px solid var(--brand); background:#e9f8f6; color:var(--brand); border-radius:999px; padding:10px 14px; font-weight:800; cursor:pointer; box-shadow:0 8px 18px rgba(19,40,66,.16); }
    .chat-panel { position:fixed; right:18px; bottom:66px; width:min(390px,92vw); height:min(560px,78vh); background:#fff; border:1px solid var(--line); border-radius:12px; box-shadow:0 16px 36px rgba(20,30,48,.2); z-index:70; display:none; overflow:hidden; }
    .chat-panel.show { display:flex; flex-direction:column; }
    .chat-head { padding:10px 12px; border-bottom:1px solid var(--line); display:flex; justify-content:space-between; align-items:center; font-weight:800; }
    .chat-log { flex:1; padding:10px; overflow:auto; background:#fafcff; display:flex; flex-direction:column; gap:8px; }
    .msg { padding:8px 10px; border-radius:10px; font-size:13px; line-height:1.5; max-width:88%; white-space:pre-wrap; }
    .msg.user { align-self:flex-end; background:#e9f8f6; border:1px solid #cdebe6; }
    .msg.ai { align-self:flex-start; background:#fff; border:1px solid #e2e8f0; }
    .chat-input { border-top:1px solid var(--line); padding:10px; display:flex; gap:8px; }
    .chat-input textarea { flex:1; resize:none; min-height:64px; max-height:140px; border:1px solid var(--line); border-radius:8px; padding:8px; outline:none; font-family:inherit; }
    .chat-send { border:1px solid var(--brand); background:var(--brand-soft); color:var(--brand); border-radius:8px; padding:8px 10px; font-weight:700; cursor:pointer; }

    @media (max-width:920px){ .layout{grid-template-columns:1fr} .sidebar{border-right:none;border-bottom:1px solid var(--line)} .member-list{max-height:240px} .grid{grid-template-columns:1fr} .detail-name{font-size:22px} }
  </style>
</head>
<body>
  <main class="app">
    <header class="head">
      <div>
        <h1 class="title">创新π协会成员名录</h1>
        <p class="desc">左侧成员列表，右侧详情面板，便于快速查看信息。</p>
      </div>
      <div class="head-right">
        <div class="status" id="authText">未登录（仅显示基础信息）</div>
        <button class="btn" id="authBtn" type="button">登录查看完整信息</button>
      </div>
    </header>

    <section class="layout">
      <aside class="sidebar">
        <input id="search" class="search" type="search" placeholder="搜索姓名" />
        <div class="count" id="count">共 0 人</div>
        <div class="member-list" id="memberList"></div>
      </aside>
      <section class="content" id="detailPane">
        <div class="empty-detail">从左侧选择一位成员查看信息。</div>
      </section>
    </section>
  </main>

  <button id="chatFab" class="chat-fab" type="button">问 Assistant</button>
  <section id="chatPanel" class="chat-panel">
    <div class="chat-head">
      <span>Assistant 在线答疑</span>
      <button id="chatClose" class="btn-ghost" type="button">关闭</button>
    </div>
    <div id="chatLog" class="chat-log">
      <div class="msg ai">你好，我在这里。你可以问我成员信息、网站使用问题，或让我要点总结。</div>
    </div>
    <div class="chat-input">
      <textarea id="chatInput" placeholder="输入你的问题...（需先登录）"></textarea>
      <button id="chatSend" class="chat-send" type="button">发送</button>
    </div>
  </section>

  <section class="modal" id="loginModal">
    <article class="login-panel">
      <h2 class="login-title">登录</h2>
      <input id="username" class="in" type="text" placeholder="账号" />
      <input id="password" class="in" type="password" placeholder="密码" />
      <div class="err" id="loginErr"></div>
      <div class="login-actions">
        <button class="btn" id="doLogin" type="button">登录</button>
        <button class="btn-ghost" id="cancelLogin" type="button">取消</button>
      </div>
    </article>
  </section>

  <script>
    let token = localStorage.getItem("pi_member_token") || "";
    let isLoggedIn = !!token;
    let members = [];
    let fullMembers = [];
    let selectedName = "";

    const memberList = document.getElementById("memberList");
    const detailPane = document.getElementById("detailPane");
    const count = document.getElementById("count");
    const search = document.getElementById("search");
    const authText = document.getElementById("authText");
    const authBtn = document.getElementById("authBtn");

    const loginModal = document.getElementById("loginModal");
    const username = document.getElementById("username");
    const password = document.getElementById("password");
    const loginErr = document.getElementById("loginErr");
    const doLogin = document.getElementById("doLogin");
    const cancelLogin = document.getElementById("cancelLogin");

    const chatFab = document.getElementById("chatFab");
    const chatPanel = document.getElementById("chatPanel");
    const chatClose = document.getElementById("chatClose");
    const chatLog = document.getElementById("chatLog");
    const chatInput = document.getElementById("chatInput");
    const chatSend = document.getElementById("chatSend");

    function appendMsg(text, role = "ai") {
      const div = document.createElement("div");
      div.className = `msg ${role}`;
      div.textContent = text;
      chatLog.appendChild(div);
      chatLog.scrollTop = chatLog.scrollHeight;
    }

    async function sendChat() {
      const q = chatInput.value.trim();
      if (!q) return;
      if (!isLoggedIn || !token) {
        appendMsg("请先登录后再使用问答功能。", "ai");
        return;
      }
      appendMsg(q, "user");
      chatInput.value = "";
      chatSend.disabled = true;
      try {
        const res = await fetch("/api/ask", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify({ message: q }),
        });
        const data = await res.json();
        if (!res.ok || !data.ok) {
          if (data.error === "rate_limited") appendMsg("请求太快了，稍等再问。", "ai");
          else if (data.error === "unauthorized") appendMsg("登录已失效，请重新登录。", "ai");
          else appendMsg("暂时无法回答，请稍后重试。", "ai");
          return;
        }
        appendMsg(data.answer || "我暂时没有可返回的内容。", "ai");
      } catch {
        appendMsg("网络或服务暂时不可用，请稍后重试。", "ai");
      } finally {
        chatSend.disabled = false;
      }
    }

    function getSource() {
      return isLoggedIn && fullMembers.length ? fullMembers : members;
    }

    function updateAuthUI() {
      authText.textContent = isLoggedIn ? "已登录（可查看完整信息）" : "未登录（仅显示基础信息）";
      authBtn.textContent = isLoggedIn ? "退出登录" : "登录查看完整信息";
    }

    function mask(v, fallback = "待补充") {
      return isLoggedIn ? (v || fallback) : "登录后可见";
    }

    function renderDetail(name) {
      const source = getSource();
      const m = source.find((x) => x.name === name);
      if (!m) {
        detailPane.innerHTML = '<div class="empty-detail">从左侧选择一位成员查看信息。</div>';
        return;
      }
      const locked = !isLoggedIn ? '<div class="locked">当前未登录：联系方式、QQ、性格、爱好特长、简历、构想已隐藏。</div>' : '';
      detailPane.innerHTML = `
        <div class="detail-title"><h2 class="detail-name">${m.name}</h2><span class="tag">${isLoggedIn ? "完整信息" : "基础信息"}</span></div>
        ${locked}
        <div class="grid">
          <div class="field"><div class="field-k">学号</div><div class="field-v">${mask(m.studentId)}</div></div>
          <div class="field"><div class="field-k">性别</div><div class="field-v">${m.gender || "待补充"}</div></div>
          <div class="field"><div class="field-k">班级</div><div class="field-v">${m.className || "待补充"}</div></div>
          <div class="field"><div class="field-k">专业</div><div class="field-v">${m.major || "待补充"}</div></div>
          <div class="field"><div class="field-k">联系方式</div><div class="field-v">${mask(m.phone)}</div></div>
          <div class="field"><div class="field-k">QQ</div><div class="field-v">${mask(m.qq)}</div></div>
          <div class="field"><div class="field-k">性格</div><div class="field-v">${mask(m.personality)}</div></div>
          <div class="field"><div class="field-k">爱好特长</div><div class="field-v">${mask(m.hobby)}</div></div>
        </div>
        <div class="block"><h3>个人简历</h3><p>${mask(m.resume)}</p></div>
        <div class="block"><h3>想法 / 项目构想</h3><p>${mask(m.idea)}</p></div>
      `;
    }

    function renderList(list) {
      memberList.innerHTML = "";
      count.textContent = `共 ${list.length} 人`;
      if (!list.length) {
        memberList.innerHTML = '<div class="empty-detail">没有匹配结果。</div>';
        detailPane.innerHTML = '<div class="empty-detail">没有可展示的成员。</div>';
        return;
      }
      list.forEach((m) => {
        const el = document.createElement("button");
        el.type = "button";
        el.className = "member-item" + (m.name === selectedName ? " active" : "");
        el.innerHTML = `<p class="member-name">${m.name}</p><div class="member-meta">${m.className || "班级待补充"} · ${m.major || "专业待补充"}</div>`;
        el.addEventListener("click", () => { selectedName = m.name; renderAll(); });
        memberList.appendChild(el);
      });
      if (!selectedName || !list.some((x) => x.name === selectedName)) selectedName = list[0].name;
      renderDetail(selectedName);
    }

    function applySearch(list) {
      const q = search.value.trim();
      if (!q) return list;
      return list.filter((m) => m.name.includes(q));
    }

    function renderAll() {
      renderList(applySearch(getSource()));
      updateAuthUI();
    }

    async function fetchPartial() {
      const res = await fetch("/api/members");
      const data = await res.json();
      members = data.members || [];
    }

    async function fetchFull() {
      const res = await fetch("/api/members/full", { headers: { Authorization: `Bearer ${token}` } });
      if (!res.ok) throw new Error("unauthorized");
      const data = await res.json();
      fullMembers = data.members || [];
    }

    async function refreshData() {
      await fetchPartial();
      if (isLoggedIn) {
        try { await fetchFull(); }
        catch {
          isLoggedIn = false;
          token = "";
          localStorage.removeItem("pi_member_token");
          fullMembers = [];
        }
      }
      renderAll();
    }

    authBtn.addEventListener("click", () => {
      if (isLoggedIn) {
        isLoggedIn = false; token = ""; fullMembers = [];
        localStorage.removeItem("pi_member_token");
        renderAll();
        return;
      }
      username.value = ""; password.value = ""; loginErr.textContent = "";
      loginModal.classList.add("show"); username.focus();
    });

    doLogin.addEventListener("click", async () => {
      const res = await fetch("/api/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username: username.value.trim(), password: password.value }),
      });
      if (!res.ok) { loginErr.textContent = "账号或密码错误，请重试。"; return; }
      const data = await res.json();
      token = data.token;
      localStorage.setItem("pi_member_token", token);
      isLoggedIn = true;
      loginModal.classList.remove("show");
      await refreshData();
    });

    cancelLogin.addEventListener("click", () => loginModal.classList.remove("show"));
    loginModal.addEventListener("click", (e) => { if (e.target === loginModal) loginModal.classList.remove("show"); });
    search.addEventListener("input", renderAll);

    chatFab.addEventListener("click", () => chatPanel.classList.add("show"));
    chatClose.addEventListener("click", () => chatPanel.classList.remove("show"));
    chatSend.addEventListener("click", sendChat);
    chatInput.addEventListener("keydown", (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === "Enter") sendChat();
    });

    refreshData();
  </script>
</body>
</html>
